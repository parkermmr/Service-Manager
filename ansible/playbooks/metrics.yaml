---
- name: Ensure Prometheus directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
  loop:
    - "{{ prometheus_config_dir }}"
    - "{{ prometheus_data_dir }}"
    - "{{ prometheus_log_dir }}"
    - "{{ node_exporter_log_dir }}"

- name: Create Prometheus configuration from template
  template:
    src: templates/prometheus.yml.j2
    dest: "{{ prometheus_config }}"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0644'
  notify:
    - Restart Prometheus

- name: Create Prometheus start script
  template:
    src: templates/start-prometheus.sh.j2
    dest: "{{ app_dir }}/bin/start-prometheus.sh"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Create Node Exporter start script
  template:
    src: templates/start-node-exporter.sh.j2
    dest: "{{ app_dir }}/bin/start-node-exporter.sh"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Check if Prometheus is running
  shell: "pgrep -f 'prometheus.*--config.file' || true"
  register: prometheus_running
  changed_when: false

- name: Check if Node Exporter is running
  shell: "pgrep -f 'node_exporter' || true"
  register: node_exporter_running
  changed_when: false

- name: Start Prometheus if not running
  shell: "nohup {{ app_dir }}/bin/start-prometheus.sh > {{ prometheus_log_dir }}/prometheus.log 2>&1 &"
  when: prometheus_running.stdout == ""
  args:
    executable: /bin/bash

- name: Start Node Exporter if not running
  shell: "nohup {{ app_dir }}/bin/start-node-exporter.sh > {{ node_exporter_log_dir }}/node_exporter.log 2>&1 &"
  when: node_exporter_running.stdout == ""
  args:
    executable: /bin/bash

- name: Wait for Prometheus to be ready
  wait_for:
    host: localhost
    port: 9090
    delay: 2
    timeout: 30
  ignore_errors: true

- name: Wait for Node Exporter to be ready
  wait_for:
    host: localhost
    port: 9100
    delay: 2
    timeout: 30
  ignore_errors: true