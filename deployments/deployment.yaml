##########################################
# DOCKER COMPOSE - NODE DEPLOYMENT
##########################################
# Deploy multiple application nodes
# Usage: docker compose -f docker/deployment.yaml up -d
services:
  ##########################################
  # NODE 1
  ##########################################
  node-1:
    image: ${REGISTRY:-localhost}/node-generic:${VERSION:-v1.0.0}
    container_name: node-1
    hostname: node-1
    restart: unless-stopped
    user: "${USER_UID:-1000}:${USER_GID:-1000}"
    ports:
      - "2223:2222"  # SSH
      - "9101:9100"  # Node Exporter
    volumes:
      - ~/.ssh/ansible.pub:/tmp/ansible.pub:ro
      - node-1-prometheus:/home/${USERNAME:-somebody}/prometheus/data
    networks:
      - monitoring
    environment:
      - USERNAME=${USERNAME:-somebody}

  ##########################################
  # NODE 2
  ##########################################
  node-2:
    image: ${REGISTRY:-localhost}/node-generic:${VERSION:-v1.0.0}
    container_name: node-2
    hostname: node-2
    restart: unless-stopped
    user: "${USER_UID:-1000}:${USER_GID:-1000}"
    ports:
      - "2224:2222"  # SSH
      - "9102:9100"  # Node Exporter
    volumes:
      - ~/.ssh/ansible.pub:/tmp/ansible.pub:ro
      - node-2-prometheus:/home/${USERNAME:-somebody}/prometheus/data
    networks:
      - monitoring
    environment:
      - USERNAME=${USERNAME:-somebody}

  ##########################################
  # NODE 3
  ##########################################
  node-3:
    image: ${REGISTRY:-localhost}/node-generic:${VERSION:-v1.0.0}
    container_name: node-3
    hostname: node-3
    restart: unless-stopped
    user: "${USER_UID:-1000}:${USER_GID:-1000}"
    ports:
      - "2225:2222"  # SSH
      - "9103:9100"  # Node Exporter
    volumes:
      - ~/.ssh/ansible.pub:/tmp/ansible.pub:ro
      - node-3-prometheus:/home/${USERNAME:-somebody}/prometheus/data
    networks:
      - monitoring
    environment:
      - USERNAME=${USERNAME:-somebody}

##########################################
# VOLUMES
##########################################
volumes:
  node-1-prometheus:
  node-2-prometheus:
  node-3-prometheus:

##########################################
# NETWORKS
##########################################
networks:
  monitoring:
    name: monitoring
    driver: bridge